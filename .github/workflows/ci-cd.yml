# name: CI/CD

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# env:
#   REGISTRY: docker.io
#   IMAGE_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}

# jobs:
#   build-and-push:
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         service: [products-cna-microservice, search-cna-microservice, users-cna-microservice, cart-cna-microservice, store-ui]
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v2

#       - name: Login to registry
#         uses: docker/login-action@v2
#         with:
#           registry: docker.io
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Build and push image
#         working-directory: ${{ matrix.service }}
#         run: |
#           IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.service }}:latest
#           docker build -t "$IMAGE" .
#           docker push "$IMAGE"

#   deploy-dev:
#     needs: build-and-push
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Set up kubectl
#         uses: azure/setup-kubectl@v3
#         with:
#           version: 'v1.27.0'

#       - name: Configure kubeconfig
#         run: |
#           echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > kubeconfig
#           mkdir -p ~/.kube
#           mv kubeconfig ~/.kube/config

#       - name: Deploy Helm charts (dev)
#         run: |
#           helm repo add bitnami https://charts.bitnami.com/bitnami || true
#           helm repo update
#           helm upgrade --install ecommerce-products k8s/helm/ecommerce-products -n ecommerce -f k8s/values-dev.yaml --create-namespace
#           helm upgrade --install ecommerce-users k8s/helm/ecommerce-users -n ecommerce -f k8s/values-dev.yaml
#           helm upgrade --install ecommerce-search k8s/helm/ecommerce-search -n ecommerce -f k8s/values-dev.yaml
#           helm upgrade --install ecommerce-cart k8s/helm/ecommerce-cart -n ecommerce -f k8s/values-dev.yaml
#           helm upgrade --install ecommerce-frontend k8s/helm/ecommerce-frontend -n ecommerce -f k8s/values-dev.yaml

#   deploy-prod:
#     needs: build-and-push
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main' && github.event.inputs.deploy == 'prod'
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Set up kubectl
#         uses: azure/setup-kubectl@v3
#         with:
#           version: 'v1.27.0'

#       - name: Configure kubeconfig
#         run: |
#           echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > kubeconfig
#           mkdir -p ~/.kube
#           mv kubeconfig ~/.kube/config

#       - name: Deploy Helm charts (prod)
#         run: |
#           helm repo add bitnami https://charts.bitnami.com/bitnami || true
#           helm repo update
#           helm upgrade --install ecommerce-postgres k8s/helm/ecommerce-postgres -n ecommerce -f k8s/values-prod.yaml --create-namespace
#           helm upgrade --install ecommerce-mongodb k8s/helm/ecommerce-mongodb -n ecommerce -f k8s/values-prod.yaml
#           helm upgrade --install ecommerce-redis k8s/helm/ecommerce-redis -n ecommerce -f k8s/values-prod.yaml
#           helm upgrade --install ecommerce-products k8s/helm/ecommerce-products -n ecommerce -f k8s/values-prod.yaml
#           helm upgrade --install ecommerce-users k8s/helm/ecommerce-users -n ecommerce -f k8s/values-prod.yaml
#           helm upgrade --install ecommerce-search k8s/helm/ecommerce-search -n ecommerce -f k8s/values-prod.yaml
#           helm upgrade --install ecommerce-cart k8s/helm/ecommerce-cart -n ecommerce -f k8s/values-prod.yaml
#           helm upgrade --install ecommerce-frontend k8s/helm/ecommerce-frontend -n ecommerce -f k8s/values-prod.yaml
