# Kind Kubernetes Cluster Configuration - Dev/Local Testing
# Production-ready configuration with multiple worker nodes
apiVersion: kind.x-k8s.io/v1alpha4
kind: Cluster
name: ecommerce-cluster
networking:
  # Enable API server access from outside the container
  apiServerAddress: "127.0.0.1"
  apiServerPort: 6443
  podSubnet: "10.244.0.0/16"
  serviceSubnet: "10.96.0.0/12"
  # Enable dual-stack (IPv4 and IPv6)
  ipFamily: ipv4
nodes:
  # Control plane node
  - role: control-plane
    image: kindest/node:v1.27.3
    extraPortMappings:
      # Expose ingress controller on localhost
      - containerPort: 80
        hostPort: 8080
        protocol: TCP
      - containerPort: 443
        hostPort: 8443
        protocol: TCP
      # Expose additional services for local testing
      - containerPort: 30000
        hostPort: 30000
        protocol: TCP
    labels:
      workload: system
      cluster-role: master
    extraMounts:
      - hostPath: /tmp/kind-storage
        containerPath: /mnt/storage
  # Worker nodes for microservices
  - role: worker
    image: kindest/node:v1.27.3
    labels:
      workload: backend
      node-pool: microservices
    extraMounts:
      - hostPath: /tmp/kind-storage
        containerPath: /mnt/storage
  - role: worker
    image: kindest/node:v1.27.3
    labels:
      workload: backend
      node-pool: microservices
    extraMounts:
      - hostPath: /tmp/kind-storage
        containerPath: /mnt/storage
  - role: worker
    image: kindest/node:v1.27.3
    labels:
      workload: database
      node-pool: data
    extraMounts:
      - hostPath: /tmp/kind-storage
        containerPath: /mnt/storage
featureGates:
  # Ensure critical features are enabled
  EphemeralContainers: true
  LocalStorageCapacityIsolation: true
containerdConfigPatches:
  - |-
    [plugins."io.containerd.grpc.v1.cri"]
      systemd_cgroup = true
